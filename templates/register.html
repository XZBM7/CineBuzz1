{% extends "base.html" %}

{% block content %}
<body data-test-mode="{{ request.args.get('test', '0') }}">
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">

                <h2 class="card-title text-center">Register</h2>

                {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
                {% endif %}

                <form method="POST" action="{{ url_for('register') }}" id="registerForm" novalidate>

                    <div class="mb-3">
                        <label for="name" class="form-label">
                            <i class="bi bi-person"></i> Full Name
                        </label>
                        <input type="text" class="form-control" id="name" name="name" required>
                        <div class="validation-feedback" id="nameFeedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">
                            <i class="bi bi-envelope"></i> Email
                        </label>
                        <input type="email" class="form-control" id="email" name="email" required>
                        <div class="validation-feedback" id="emailFeedback"></div>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="bi bi-lock"></i> Password
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="password">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="validation-feedback" id="passwordFeedback"></div>

                        <div class="password-requirements">
                            <small>Password must contain:</small>
                            <ul class="list-unstyled mt-1">
                                <li class="requirement" data-requirement="length">✓ At least 8 characters</li>
                                <li class="requirement" data-requirement="uppercase">✓ One uppercase letter</li>
                                <li class="requirement" data-requirement="lowercase">✓ One lowercase letter</li>
                                <li class="requirement" data-requirement="number">✓ One number</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">
                            <i class="bi bi-lock-fill"></i> Confirm Password
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">
                            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="confirmPassword">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                        <div class="validation-feedback" id="confirmPasswordFeedback"></div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Register</button>
                </form>

                <div class="mt-3 text-center">
                    Already have an account?
                    <a href="{{ url_for('login') }}">Login here</a>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    document.body.classList.add('auth-page');

    if (!document.querySelector('link[href*="bootstrap-icons"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css';
        document.head.appendChild(link);
    }

    document.querySelectorAll('.toggle-password').forEach(button => {
        button.addEventListener('click', function () {
            const targetId = this.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);
            const icon = this.querySelector('i');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });
    });

    const inputs = {
        name: document.getElementById('name'),
        email: document.getElementById('email'),
        password: document.getElementById('password'),
        confirmPassword: document.getElementById('confirmPassword')
    };

    const feedback = {
        name: document.getElementById('nameFeedback'),
        email: document.getElementById('emailFeedback'),
        password: document.getElementById('passwordFeedback'),
        confirmPassword: document.getElementById('confirmPasswordFeedback')
    };

    function validateName() {
        if (!inputs.name.value.trim()) {
            showError(inputs.name, feedback.name, 'Please enter your full name.');
            return false;
        }
        showSuccess(inputs.name, feedback.name, 'Name looks good!');
        return true;
    }

    function validateEmail() {
        const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!inputs.email.value) {
            showError(inputs.email, feedback.email, 'Please enter your email address.');
            return false;
        }
        if (!regex.test(inputs.email.value)) {
            showError(inputs.email, feedback.email, 'Please enter a valid email address.');
            return false;
        }
        showSuccess(inputs.email, feedback.email, 'Email looks good!');
        return true;
    }

    function validatePassword() {
        const pass = inputs.password.value;
        const requirements = {
            length: pass.length >= 8,
            uppercase: /[A-Z]/.test(pass),
            lowercase: /[a-z]/.test(pass),
            number: /[0-9]/.test(pass)
        };

        updatePasswordRequirements();

        if (!Object.values(requirements).every(Boolean)) {
            showError(inputs.password, feedback.password, 'Password does not meet all requirements.');
            return false;
        }

        showSuccess(inputs.password, feedback.password, 'Password is strong!');
        return true;
    }

    function validatePasswordMatch() {
        const pass = inputs.password.value;
        const conf = inputs.confirmPassword.value;

        if (!conf) {
            showError(inputs.confirmPassword, feedback.confirmPassword, 'Please confirm your password.');
            return false;
        }
        if (pass !== conf) {
            showError(inputs.confirmPassword, feedback.confirmPassword, 'Passwords do not match!');
            return false;
        }

        showSuccess(inputs.confirmPassword, feedback.confirmPassword, 'Passwords match!');
        return true;
    }

    function updatePasswordRequirements() {
        const pass = inputs.password.value;
        const states = {
            length: pass.length >= 8,
            uppercase: /[A-Z]/.test(pass),
            lowercase: /[a-z]/.test(pass),
            number: /[0-9]/.test(pass)
        };

        Object.keys(states).forEach(req => {
            const element = document.querySelector(`[data-requirement="${req}"]`);
            if (states[req]) {
                element.classList.add('valid');
                element.classList.remove('invalid');
            } else {
                element.classList.add('invalid');
                element.classList.remove('valid');
            }
        });
    }

    function showError(input, msgEl, msg) {
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
        msgEl.textContent = msg;
        msgEl.className = 'validation-feedback error';
    }

    function showSuccess(input, msgEl, msg) {
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
        msgEl.textContent = msg;
        msgEl.className = 'validation-feedback success';
    }

    document.getElementById('registerForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const isNameValid = validateName();
        const isEmailValid = validateEmail();
        const isPasswordValid = validatePassword();
        const isPasswordMatchValid = validatePasswordMatch();

        const testMode = document.body.getAttribute('data-test-mode') === "1";


        if (isNameValid && isEmailValid && isPasswordValid) {
            console.log("Submitting (testMode =", testMode, ")");
            this.submit();
        }
    });

</script>

<style>
    .toggle-password { border-left: 0; }
    .form-control.is-valid { border-color: #28a745; }
    .form-control.is-invalid { border-color: #dc3545; }
    .validation-feedback.success { color: #28a745; }
    .validation-feedback.error { color: #dc3545; }
    .requirement.valid { color: #28a745; }
    .requirement.invalid { color: #dc3545; }
</style>

{% endblock %}
